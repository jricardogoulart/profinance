<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transações | ProFinance</title>
  <link rel="stylesheet" href="output.css" />
  <script src="theme.js" defer></script>
</head>
<body class="bg-white text-gray-900 dark:bg-gray-900 dark:text-white">
  <!-- Navbar -->
  <nav class="bg-gray-900 dark:bg-gray-800 shadow-lg px-6 py-3 flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <img src="assets/profinance.svg" alt="ProFinance" />
    </div>

    <div class="hidden md:flex space-x-6">
      <a href="dashboard.html" class="text-gray-300 hover:text-white transition">Dashboard</a>
      <a href="contas.html" class="text-gray-300 hover:text-white transition">Contas</a>
      <a href="transacoes.html" class="text-gray-300 hover:text-white transition">Transações</a>
      <a href="relatorios.html" class="text-gray-300 hover:text-white transition">Relatórios</a>
      <a href="configuracoes.html" class="text-gray-300 hover:text-white transition">Configurações</a>
    </div>

    <div class="md:hidden">
      <button id="menu-btn" class="text-white focus:outline-none">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
      </button>
    </div>
  </nav>

  <!-- Menu Mobile -->
  <div id="mobile-menu" class="hidden bg-gray-800 md:hidden flex flex-col space-y-3 p-4">
    <a href="dashboard.html" class="text-gray-300 hover:text-white transition">Dashboard</a>
    <a href="contas.html" class="text-gray-300 hover:text-white transition">Contas</a>
    <a href="transacoes.html" class="text-gray-300 hover:text-white transition">Transações</a>
    <a href="relatorios.html" class="text-gray-300 hover:text-white transition">Relatórios</a>
    <a href="configuracoes.html" class="text-gray-300 hover:text-white transition">Configurações</a>
  </div>

  <main class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-6">Cadastro de Transações</h1>

    <!-- Formulário -->
    <div class="card mb-6 p-4 rounded shadow">
      <form id="form-transacao" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <select id="conta" class="border rounded-lg p-2" required>
          <option value="">Selecione a Conta</option>
        </select>
        <input id="titulo" class="border rounded-lg p-2" type="text" placeholder="Título da Transação" required />
        <input id="valor" class="border rounded-lg p-2" type="number" step="0.01" placeholder="Valor" required />
        <select id="tipo" class="border rounded-lg p-2" required>
          <option value="">Tipo</option>
          <option value="credito">Crédito</option>
          <option value="debito">Débito</option>
        </select>
        <input id="data" class="border rounded-lg p-2" type="date" required />
        <textarea id="descricao" class="border rounded-lg p-2 col-span-full" placeholder="Descrição"></textarea>
        <button class="button-primary col-span-full">Salvar Transação</button>
      </form>
    </div>

    <!-- Filtros -->
    <div class="card mb-6 p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-3">Filtros</h2>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <select id="filter-tipo" class="border rounded-lg p-2">
          <option value="">Todos os Tipos</option>
          <option value="credito">Crédito</option>
          <option value="debito">Débito</option>
        </select>
        <select id="sort-date" class="border rounded-lg p-2">
          <option value="desc">Mais Recentes</option>
          <option value="asc">Mais Antigos</option>
        </select>
        <input id="min-value" type="number" step="0.01" placeholder="Valor Mínimo" class="border rounded-lg p-2" />
        <input id="max-value" type="number" step="0.01" placeholder="Valor Máximo" class="border rounded-lg p-2" />
        <div class="flex gap-2">
          <button id="apply-filters" class="button-primary w-full">Aplicar</button>
          <button id="clear-filters" class="button-danger w-full">Limpar</button>
        </div>
      </div>
    </div>

    <!-- Lista -->
    <div class="card p-4 rounded shadow">
      <h2 class="text-lg font-semibold mb-4">Transações Cadastradas</h2>
      <div class="overflow-x-auto">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Data</th>
              <th>Conta</th>
              <th>Título</th>
              <th>Tipo</th>
              <th>Valor</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tabela-transacoes">
            <!-- Linhas dinâmicas -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    // Helpers
    function formatBRL(valor, tipo) {
      const sign = tipo === "debito" ? "-" : "";
      return sign + new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(Math.abs(valor || 0));
    }

    function safeText(text) {
      return text == null ? "" : String(text);
    }

    // DOM Elements
    const form = document.getElementById("form-transacao");
    const tabela = document.getElementById("tabela-transacoes");
    const selectContas = document.getElementById("conta");

    // Filtros
    const filterTipo = document.getElementById("filter-tipo");
    const sortDate = document.getElementById("sort-date");
    const minValue = document.getElementById("min-value");
    const maxValue = document.getElementById("max-value");

    const btnApply = document.getElementById("apply-filters");
    const btnClear = document.getElementById("clear-filters");

    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function carregarContas(selectFirst = true) {
      const contas = await window.profinanceAPI.listarContas();
      selectContas.innerHTML = '<option value="">Selecione a Conta</option>';
      contas.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = `${c.nome} (${c.banco})`;
        selectContas.appendChild(opt);
      });

      const contaParam = getQueryParam("conta");
      if (contaParam && contas.some(c => String(c.id) === String(contaParam))) {
        selectContas.value = contaParam;
      } else if (selectFirst && contas.length) {
        selectContas.value = contas[0].id;
      }
    }

    async function carregarTransacoes() {
      const contaId = selectContas.value;
      if (!contaId) {
        tabela.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Selecione uma conta</td></tr>';
        return;
      }

      const params = {
        contaId: Number(contaId),
        tipoFilter: filterTipo.value || null,
        minValue: minValue.value ? Number(minValue.value) : undefined,
        maxValue: maxValue.value ? Number(maxValue.value) : undefined,
        sort: sortDate.value || "desc"
      };

      const transacoes = await window.profinanceAPI.queryTransacoes(params);

      if (!transacoes.length) {
        tabela.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Nenhuma transação encontrada.</td></tr>';
        return;
      }

      tabela.innerHTML = transacoes.map(t => {
        const isCredito = t.tipo === "credito";
        const bgClass = isCredito ? "bg-green-600" : "bg-red-600";
        const tipoLabel = isCredito ? "Crédito" : "Débito";
        return `
          <tr>
            <td>${safeText(t.data)}</td>
            <td>${safeText(t.conta_nome)}</td>
            <td>${safeText(t.titulo)}</td>
            <td class="px-2 py-1 ${bgClass} text-white rounded text-center">${tipoLabel}</td>
            <td class="text-right font-medium">${formatBRL(t.valor, t.tipo)}</td>
            <td class="text-center">
              <button onclick="excluirTransacao(${t.id})" class="bg-red-500 text-white px-3 py-1 rounded">Excluir</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const transacao = {
        conta_id: Number(selectContas.value),
        titulo: document.getElementById("titulo").value.trim(),
        valor: parseFloat(document.getElementById("valor").value),
        tipo: document.getElementById("tipo").value,
        data: document.getElementById("data").value || new Date().toISOString().slice(0, 10),
        descricao: document.getElementById("descricao").value.trim()
      };
      await window.profinanceAPI.addTransacao(transacao);
      showToast("Transação salva", "success");
      await carregarTransacoes();
    });

    async function excluirTransacao(id) {
      if (!confirm("Confirma exclusão desta transação?")) return;
      await window.profinanceAPI.excluirTransacao(id);
      showToast("Transação excluída", "info");
      await carregarTransacoes();
    }
    window.excluirTransacao = excluirTransacao;

    btnApply.addEventListener("click", carregarTransacoes);
    btnClear.addEventListener("click", () => {
      filterTipo.value = "";
      sortDate.value = "desc";
      minValue.value = "";
      maxValue.value = "";
      carregarTransacoes();
    });

    selectContas.addEventListener("change", carregarTransacoes);

    function showToast(text, type = "info") {
      let t = document.getElementById("__toast");
      if (!t) {
        t = document.createElement("div");
        t.id = "__toast";
        t.style.position = "fixed";
        t.style.right = "20px";
        t.style.bottom = "20px";
        t.style.zIndex = 9999;
        document.body.appendChild(t);
      }
      const el = document.createElement("div");
      el.className = "p-3 rounded shadow-lg mb-2";
      el.style.minWidth = "200px";
      if (type === "success") { el.style.background = "#10B981"; el.style.color = "white"; }
      else if (type === "info") { el.style.background = "#3B82F6"; el.style.color = "white"; }
      else { el.style.background = "#EF4444"; el.style.color = "white"; }
      el.innerText = text;
      t.appendChild(el);
      setTimeout(() => el.remove(), 3500);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await carregarContas(true);
      await carregarTransacoes();
    });
  </script>
</body>
</html>
